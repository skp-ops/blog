---
import { getCollection } from 'astro:content'
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  type PathItem = {
    params: { gallery: string }
    props: { lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  paths.push({
    params: { gallery: 'gallery/' },
    props: { lang: defaultLocale },
  })

  // More locales
  moreLocales.forEach((lang: string) => {
    paths.push({
      params: { gallery: `${lang}/gallery/` },
      props: { lang },
    })
  })

  return paths
}

const { lang } = Astro.props
const photos = await getCollection('photos')

// Sort photos by date (newest first)
const sortedPhotos = photos.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
)

const PHOTOS_PER_PAGE = 12
const initialPhotos = sortedPhotos.slice(0, PHOTOS_PER_PAGE)
const totalPages = Math.ceil(sortedPhotos.length / PHOTOS_PER_PAGE)

const toStr = (v: unknown) => (v === undefined || v === null ? '' : String(v))

// (Dates are now formatted in the zoom overlay component)

// Get translation text
const translations = {
  en: {
    title: 'Gallery',
    totalPhotos: 'Total',
    photos: 'photos',
    page: 'Page',
    of: 'of',
    previous: 'Previous',
    next: 'Next',
  },
  zh: {
    title: '画廊',
    totalPhotos: '共',
    photos: '张照片',
    page: '第',
    of: '页，共',
    previous: '上一页',
    next: '下一页',
  },
  ja: {
    title: 'ギャラリー',
    totalPhotos: '合計',
    photos: '枚の写真',
    page: 'ページ',
    of: '/',
    previous: '前へ',
    next: '次へ',
  },
}
const t = translations[lang as keyof typeof translations] || translations.en
---

<Layout>
  <div class="gallery-page">
    <h1 class="gallery-title">{t.title}</h1>
    <p class="gallery-desc">
      {t.totalPhotos} <span id="gallery-total">{sortedPhotos.length}</span> {t.photos}
    </p>

    <div class="gallery-grid" id="gallery-grid" data-total-photos={sortedPhotos.length} data-photos-per-page={PHOTOS_PER_PAGE}>
      {initialPhotos.map(photo => (
        <div class="gallery-item" data-photo-id={photo.id}>
          <div class="gallery-card">
            <div class="gallery-image-wrapper">
              <img
                src={photo.data.thumbnail || photo.data.image}
                alt={photo.data.title}
                class="gallery-image"
                loading="lazy"
                decoding="async"
                fetchpriority={photo.id === 'sample-photo-1' ? 'high' : 'auto'}
                data-full-image={photo.data.image}
                data-title={photo.data.title}
                data-location={toStr(photo.data.location)}
                data-description={toStr(photo.data.description)}
                data-date={new Date(photo.data.date).toISOString()}
                data-camera={toStr((photo.data as any).camera)}
                data-lens={toStr((photo.data as any).lens)}
                data-iso={toStr((photo.data as any).iso)}
                data-aperture={toStr((photo.data as any).aperture)}
                data-shutter={toStr((photo.data as any).shutter)}
                data-focal-length={toStr((photo.data as any).focalLength)}
              />
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="gallery-pagination" id="gallery-pagination">
      <button id="gallery-prev" class="gallery-nav-btn" disabled aria-label={t.previous}>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        <span class="nav-text">{t.previous}</span>
      </button>

      <div class="gallery-page-info">
        <span class="page-current">{t.page} <span id="gallery-current-page">1</span> {t.of} <span id="gallery-total-pages">{totalPages}</span></span>
      </div>

      <button id="gallery-next" class="gallery-nav-btn" aria-label={t.next}>
        <span class="nav-text">{t.next}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</Layout>

<style>
  .gallery-page {
    width: 100%;
  }

  .gallery-title {
    font-size: 1.75rem;
    font-weight: bold;
    color: oklch(var(--un-preset-theme-colors-primary));
    margin-bottom: 0.75rem;
  }

  @media (min-width: 1024px) {
    .gallery-title {
      font-size: 2rem;
    }
  }

  .gallery-desc {
    font-size: 0.875rem;
    color: oklch(var(--un-preset-theme-colors-secondary));
    margin-bottom: 2.5rem;
  }

  @media (min-width: 1024px) {
    .gallery-desc {
      margin-bottom: 3rem;
    }
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  @media (min-width: 640px) {
    .gallery-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.75rem;
    }
  }

  @media (min-width: 1024px) {
    .gallery-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
    }
  }

  .gallery-item {
    /* No special break properties needed for grid layout */
  }

  .gallery-card {
    position: relative;
    overflow: hidden;
    border-radius: 1.5rem; /* 24px */
    backdrop-filter: blur(14px) saturate(120%);
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.06);
    border: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.12);
    transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 8px 30px oklch(var(--un-preset-theme-colors-secondary) / 0.12);
  }

  .gallery-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 40px oklch(var(--un-preset-theme-colors-secondary) / 0.18);
    border-color: oklch(var(--un-preset-theme-colors-secondary) / 0.18);
  }

  .gallery-image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 1.5rem; /* full card */
    cursor: zoom-in;
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.04);
  }

  .gallery-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.6s ease; /* smoother iOS feel */
  }

  .gallery-card:hover .gallery-image {
    transform: scale(1.04);
  }

  /* Pagination styles */
  .gallery-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 3rem;
    padding: 1.5rem 0;
  }

  .gallery-nav-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 1rem;
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.06);
    border: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.12);
    color: oklch(var(--un-preset-theme-colors-primary));
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .gallery-nav-btn:hover:not(:disabled) {
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.12);
    border-color: oklch(var(--un-preset-theme-colors-secondary) / 0.2);
    transform: translateY(-2px);
  }

  .gallery-nav-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .gallery-nav-btn svg {
    width: 1.25rem;
    height: 1.25rem;
  }

  .gallery-page-info {
    text-align: center;
    font-size: 0.875rem;
    color: oklch(var(--un-preset-theme-colors-secondary));
    font-weight: 500;
  }

  .page-current {
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .gallery-pagination {
      gap: 0.5rem;
    }

    .gallery-nav-btn .nav-text {
      display: none;
    }

    .gallery-nav-btn {
      padding: 0.75rem;
    }
  }

  /* Thumbnail cards now only show the image (no captions) */
</style>

<script>
// Pagination logic for gallery
document.addEventListener('astro:page-load', () => {
  const grid = document.getElementById('gallery-grid')
  const prevBtn = document.getElementById('gallery-prev') as HTMLButtonElement | null
  const nextBtn = document.getElementById('gallery-next') as HTMLButtonElement | null
  const currentPageEl = document.getElementById('gallery-current-page')
  const totalPagesEl = document.getElementById('gallery-total-pages')

  if (!grid || !prevBtn || !nextBtn || !currentPageEl || !totalPagesEl)
    return

  const templateItem = grid.querySelector('.gallery-item')
  if (!templateItem)
    return

  const totalPhotos = Number.parseInt(grid.getAttribute('data-total-photos') || '0', 10)
  const photosPerPage = Number.parseInt(grid.getAttribute('data-photos-per-page') || '12', 10)
  const totalPages = Math.ceil(totalPhotos / photosPerPage)

  let currentPage = 1
  let loading = false

  const updatePagination = () => {
    currentPageEl.textContent = String(currentPage)
    totalPagesEl.textContent = String(totalPages)
    prevBtn.disabled = currentPage === 1
    nextBtn.disabled = currentPage === totalPages
  }

  const loadPage = async (page: number) => {
    if (loading || page < 1 || page > totalPages)
      return
    loading = true

    try {
      const offset = (page - 1) * photosPerPage
      const res = await fetch(`/api/photos.json?offset=${offset}&limit=${photosPerPage}`)
      if (!res.ok)
        throw new Error(`HTTP ${res.status}`)
      const data = await res.json()
      const items = Array.isArray(data.items) ? data.items : []

      // Clear current items
      grid.innerHTML = ''

      // Add new items
      const frag = document.createDocumentFragment()
      for (const photo of items) {
        const item = templateItem.cloneNode(true) as HTMLElement
        item.setAttribute('data-photo-id', photo.id)

        const img = item.querySelector('img.gallery-image') as HTMLImageElement | null
        if (img) {
          img.src = String(photo.thumbnail || photo.image || '')
          img.alt = String(photo.title || '')

          img.setAttribute('loading', 'lazy')
          img.setAttribute('decoding', 'async')
          img.setAttribute('fetchpriority', 'auto')

          img.setAttribute('data-full-image', String(photo.image || ''))
          img.setAttribute('data-title', String(photo.title || ''))
          img.setAttribute('data-location', String(photo.location || ''))
          img.setAttribute('data-description', String(photo.description || ''))
          img.setAttribute('data-date', String(photo.date || ''))
          img.setAttribute('data-camera', String(photo.camera || ''))
          img.setAttribute('data-lens', String(photo.lens || ''))
          img.setAttribute('data-iso', String(photo.iso || ''))
          img.setAttribute('data-aperture', String(photo.aperture || ''))
          img.setAttribute('data-shutter', String(photo.shutter || ''))
          img.setAttribute('data-focal-length', String(photo.focalLength || ''))
        }

        frag.appendChild(item)
      }
      grid.appendChild(frag)

      // Scroll to top of gallery
      const galleryPage = document.querySelector('.gallery-page')
      if (galleryPage) {
        galleryPage.scrollIntoView({ behavior: 'smooth', block: 'start' })
      }

      currentPage = page
      updatePagination()
    }
    catch (err) {
      console.error('Failed to load page:', err)
    }
    finally {
      loading = false
    }
  }

  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      loadPage(currentPage - 1)
    }
  })

  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      loadPage(currentPage + 1)
    }
  })

  updatePagination()
})
</script>
