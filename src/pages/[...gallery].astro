---
import { getCollection } from 'astro:content'
import { defaultLocale, moreLocales } from '@/config'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  type PathItem = {
    params: { gallery: string }
    props: { lang: string }
  }

  const paths: PathItem[] = []

  // Default locale
  paths.push({
    params: { gallery: 'gallery/' },
    props: { lang: defaultLocale },
  })

  // More locales
  moreLocales.forEach((lang: string) => {
    paths.push({
      params: { gallery: `${lang}/gallery/` },
      props: { lang },
    })
  })

  return paths
}

const { lang } = Astro.props
const photos = await getCollection('photos')

// Sort photos by date (newest first)
const sortedPhotos = photos.sort((a, b) =>
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
)

const INITIAL_PAGE_SIZE = 30
const initialPhotos = sortedPhotos.slice(0, INITIAL_PAGE_SIZE)

const toStr = (v: unknown) => (v === undefined || v === null ? '' : String(v))

// (Dates are now formatted in the zoom overlay component)

// Get translation text
const translations = {
  en: { title: 'Gallery', totalPhotos: 'Total', photos: 'photos' },
  zh: { title: '画廊', totalPhotos: '共', photos: '张照片' },
  ja: { title: 'ギャラリー', totalPhotos: '合計', photos: '枚の写真' },
}
const t = translations[lang as keyof typeof translations] || translations.en
---

<Layout>
  <div class="gallery-page">
    <h1 class="gallery-title">{t.title}</h1>
    <p class="gallery-desc">
      {t.totalPhotos} <span id="gallery-total">{sortedPhotos.length}</span> {t.photos}
    </p>

    <div class="gallery-grid" id="gallery-grid" data-initial-offset={initialPhotos.length}>
      {initialPhotos.map(photo => (
        <div class="gallery-item" data-photo-id={photo.id}>
          <div class="gallery-card">
            <div class="gallery-image-wrapper">
              <img
                src={photo.data.thumbnail || photo.data.image}
                alt={photo.data.title}
                class="gallery-image"
                loading="lazy"
                decoding="async"
                fetchpriority={photo.id === 'sample-photo-1' ? 'high' : 'auto'}
                data-full-image={photo.data.image}
                data-title={photo.data.title}
                data-location={toStr(photo.data.location)}
                data-description={toStr(photo.data.description)}
                data-date={new Date(photo.data.date).toISOString()}
                data-camera={toStr((photo.data as any).camera)}
                data-lens={toStr((photo.data as any).lens)}
                data-iso={toStr((photo.data as any).iso)}
                data-aperture={toStr((photo.data as any).aperture)}
                data-shutter={toStr((photo.data as any).shutter)}
                data-focal-length={toStr((photo.data as any).focalLength)}
              />
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="gallery-sentinel" id="gallery-sentinel" aria-hidden="true"></div>
  </div>
</Layout>

<style>
  .gallery-page {
    width: 100%;
  }

  .gallery-title {
    font-size: 1.75rem;
    font-weight: bold;
    color: oklch(var(--un-preset-theme-colors-primary));
    margin-bottom: 0.75rem;
  }

  @media (min-width: 1024px) {
    .gallery-title {
      font-size: 2rem;
    }
  }

  .gallery-desc {
    font-size: 0.875rem;
    color: oklch(var(--un-preset-theme-colors-secondary));
    margin-bottom: 2.5rem;
  }

  @media (min-width: 1024px) {
    .gallery-desc {
      margin-bottom: 3rem;
    }
  }

  .gallery-grid {
    column-count: 1;
    column-gap: 1.5rem;
  }

  @media (min-width: 640px) {
    .gallery-grid {
      column-count: 2;
      column-gap: 1.75rem;
    }
  }

  @media (min-width: 1024px) {
    .gallery-grid {
      column-count: 3;
      column-gap: 2rem;
    }
  }

  .gallery-item {
    break-inside: avoid;
    page-break-inside: avoid;
    margin-bottom: 1.5rem;
  }

  @media (min-width: 640px) {
    .gallery-item {
      margin-bottom: 1.75rem;
    }
  }

  @media (min-width: 1024px) {
    .gallery-item {
      margin-bottom: 2rem;
    }
  }

  .gallery-card {
    position: relative;
    overflow: hidden;
    border-radius: 1.5rem; /* 24px */
    backdrop-filter: blur(14px) saturate(120%);
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.06);
    border: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.12);
    transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease;
    box-shadow: 0 8px 30px oklch(var(--un-preset-theme-colors-secondary) / 0.12);
  }

  .gallery-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 40px oklch(var(--un-preset-theme-colors-secondary) / 0.18);
    border-color: oklch(var(--un-preset-theme-colors-secondary) / 0.18);
  }

  .gallery-image-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    border-radius: 1.5rem; /* full card */
    cursor: zoom-in;
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.04);
  }

  .gallery-image {
    width: 100%;
    height: auto;
    display: block;
    transition: transform 0.6s ease; /* smoother iOS feel */
  }

  .gallery-card:hover .gallery-image {
    transform: scale(1.04);
  }

  .gallery-sentinel {
    height: 1px;
  }

  /* Thumbnail cards now only show the image (no captions) */
</style>

<script>
  // Infinite scroll: append more photos as the sentinel enters view.
  document.addEventListener('astro:page-load', () => {
    const grid = document.getElementById('gallery-grid')
    const sentinel = document.getElementById('gallery-sentinel')
    if (!grid || !sentinel) return

    const templateItem = grid.querySelector('.gallery-item')
    if (!templateItem) return

    let offset = Number.parseInt(grid.getAttribute('data-initial-offset') || '0', 10) || 0
    const limit = 30
    let loading = false
    let done = false

    const escapeHtml = (v: unknown) => String(v ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')

    type ApiPhotoItem = {
      id: string
      image: string
      thumbnail?: string
      title: string
      location?: string
      description?: string
      date: string
      camera?: string
      lens?: string
      iso?: string
      aperture?: string
      shutter?: string
      focalLength?: string
    }

    const appendItems = (items: ApiPhotoItem[]) => {
      const frag = document.createDocumentFragment()
      for (const p of items) {
        const item = templateItem.cloneNode(true) as HTMLElement
        item.setAttribute('data-photo-id', p.id)

        const img = item.querySelector('img.gallery-image') as HTMLImageElement | null
        if (img) {
          img.src = String(p.thumbnail || p.image || '')
          img.alt = String(p.title || '')

          img.setAttribute('loading', 'lazy')
          img.setAttribute('decoding', 'async')
          img.setAttribute('fetchpriority', 'auto')

          img.setAttribute('data-full-image', String(p.image || ''))
          img.setAttribute('data-title', String(p.title || ''))
          img.setAttribute('data-location', String(p.location || ''))
          img.setAttribute('data-description', String(p.description || ''))
          img.setAttribute('data-date', String(p.date || ''))
          img.setAttribute('data-camera', String(p.camera || ''))
          img.setAttribute('data-lens', String(p.lens || ''))
          img.setAttribute('data-iso', String(p.iso || ''))
          img.setAttribute('data-aperture', String(p.aperture || ''))
          img.setAttribute('data-shutter', String(p.shutter || ''))
          img.setAttribute('data-focal-length', String(p.focalLength || ''))
        }

        frag.appendChild(item)
      }
      grid.appendChild(frag)
    }

    const loadMore = async () => {
      if (loading || done) return
      loading = true
      try {
        const res = await fetch(`/api/photos.json?offset=${offset}&limit=${limit}`)
        if (!res.ok) throw new Error(`HTTP ${res.status}`)
        const data = await res.json()
        const items = Array.isArray(data.items) ? data.items : []
        if (items.length === 0) {
          done = true
          io.disconnect()
          return
        }
        appendItems(items)
        offset += items.length
        if (typeof data.total === 'number' && offset >= data.total) {
          done = true
          io.disconnect()
        }
      }
      catch {
        // If API fails, stop retrying to avoid spamming.
        done = true
        io.disconnect()
      }
      finally {
        loading = false
      }
    }

    const io = new IntersectionObserver((entries) => {
      if (entries.some(e => e.isIntersecting)) {
        void loadMore()
      }
    }, { rootMargin: '800px 0px' })

    io.observe(sentinel)
  })
</script>
