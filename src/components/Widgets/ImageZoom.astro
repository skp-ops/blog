<script>
const ImageZoom = {
  overlay: document.querySelector('.zoom-overlay') as HTMLDivElement | null,
  zoomedImg: null as HTMLImageElement | null,
  originalImg: null as HTMLImageElement | null,
  infoCard: null as HTMLDivElement | null,
  images: [] as HTMLImageElement[],
  currentIndex: 0,
  prevBtn: null as HTMLButtonElement | null,
  nextBtn: null as HTMLButtonElement | null,

  createNavBtn(type: 'prev' | 'next') {
    const btn = document.createElement('button')
    btn.innerHTML = type === 'prev' ? '&#10094;' : '&#10095;'
    btn.setAttribute('aria-label', type === 'prev' ? 'Previous image' : 'Next image')
    Object.assign(btn.style, {
      position: 'absolute',
      top: '50%',
      [type === 'prev' ? 'left' : 'right']: '20px',
      transform: 'translateY(-50%)',
      background: 'oklch(var(--un-preset-theme-colors-background) / 0.8)',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
      border: '1px solid oklch(var(--un-preset-theme-colors-border))',
      borderRadius: '50%',
      width: '48px',
      height: '48px',
      fontSize: '20px',
      cursor: 'pointer',
      zIndex: '10000',
      display: 'none',
      alignItems: 'center',
      justifyContent: 'center',
      transition: 'all 0.2s ease',
      boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
    })
    
    btn.addEventListener('mouseenter', () => {
      btn.style.background = 'oklch(var(--un-preset-theme-colors-primary))'
      btn.style.color = 'oklch(var(--un-preset-theme-colors-background))'
    })
    btn.addEventListener('mouseleave', () => {
      btn.style.background = 'oklch(var(--un-preset-theme-colors-background) / 0.8)'
      btn.style.color = 'oklch(var(--un-preset-theme-colors-primary))'
    })
    
    btn.addEventListener('click', (e) => {
      e.stopPropagation()
      type === 'prev' ? this.prev() : this.next()
    })
    
    return btn
  },

  collectImages() {
    this.images = Array.from(document.querySelectorAll('img')).filter(img => 
      img.complete && img.naturalWidth >= 100 && img.naturalHeight >= 100 && !img.closest('.zoom-overlay')
    )
  },

  updateNavButtons() {
    if (!this.prevBtn || !this.nextBtn) return
    this.prevBtn.style.display = this.currentIndex > 0 ? 'flex' : 'none'
    this.nextBtn.style.display = this.currentIndex < this.images.length - 1 ? 'flex' : 'none'
  },

  prev() {
    if (this.currentIndex > 0) this.switchImage(this.currentIndex - 1)
  },

  next() {
    if (this.currentIndex < this.images.length - 1) this.switchImage(this.currentIndex + 1)
  },

  switchImage(index: number) {
    const img = this.images[index]
    if (!img) return
    
    if (this.zoomedImg) this.zoomedImg.remove()
    if (this.infoCard) this.infoCard.remove()
    
    this.zoomImg(img)
  },

  // Create overlay element
  createOverlay() {
    if (this.overlay && this.overlay.isConnected) {
      return
    }

    this.overlay = document.createElement('div')
    this.overlay.classList.add('zoom-overlay')
    this.overlay.setAttribute('role', 'dialog')
    this.overlay.setAttribute('aria-modal', 'true')
    this.overlay.setAttribute('aria-label', 'Image Viewer')
    this.overlay.setAttribute('tabindex', '-1')
    Object.assign(this.overlay.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      zIndex: '9999',
      backgroundColor: 'rgba(0,0,0,0.8)',
      backdropFilter: 'blur(18px)',
      opacity: '0',
      transition: 'opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)',
      cursor: 'zoom-out',
      display: 'none',
    })

    document.body.appendChild(this.overlay)

    this.prevBtn = this.createNavBtn('prev')
    this.nextBtn = this.createNavBtn('next')
    this.overlay.appendChild(this.prevBtn)
    this.overlay.appendChild(this.nextBtn)

    // Close when clicking background (but ignore clicks on floating info card)
    const overlayEl = this.overlay
    overlayEl.addEventListener('click', (e: MouseEvent) => {
      if (e.target === overlayEl) this.close()
    })
  },

  // Zoom in the image
  zoomImg(img: HTMLImageElement) {
    if (!this.overlay) {
      return
    }

    // Disable scrolling and get position
    document.body.style.overflow = 'hidden'
    
    this.collectImages()
    this.currentIndex = this.images.indexOf(img)
    this.updateNavButtons()

    const rect = img.getBoundingClientRect()
    this.originalImg = img

    // Create and style cloned image
    this.zoomedImg = img.cloneNode() as HTMLImageElement
    Object.assign(this.zoomedImg.style, {
      position: 'absolute',
      top: `${rect.top}px`,
      left: `${rect.left}px`,
      width: `${rect.width}px`,
      height: `${rect.height}px`,
      transition: 'transform 400ms cubic-bezier(0.2, 0, 0.2, 1)',
      zIndex: '1',
      cursor: 'zoom-out',
      transformOrigin: 'top left',
    })

    // Add to overlay and show
    this.overlay.appendChild(this.zoomedImg)
    this.overlay.style.display = 'block'
    this.overlay.focus()

    // Calculate target layout
    const viewportWidth = window.innerWidth
    const viewportHeight = window.innerHeight
    const isDesktop = viewportWidth > 768
    
    let targetCenterX, targetCenterY, maxW, maxH;
    
    if (isDesktop) {
        const infoWidth = 380 // Card width + margin
        const availW = viewportWidth - infoWidth
        targetCenterX = availW / 2
        targetCenterY = viewportHeight / 2
        maxW = availW - 60
        maxH = viewportHeight - 60
    } else {
        const infoHeight = 280 // Card height + margin
        const availH = viewportHeight - infoHeight
        targetCenterX = viewportWidth / 2
        targetCenterY = (availH / 2) + 20 // Add some top padding
        maxW = viewportWidth - 30
        maxH = availH - 60 // More vertical padding
    }

    const scale = Math.min(maxW / rect.width, maxH / rect.height)

    // Build and attach floating info UI
    this.attachInfoCard(img)

    // Start animation
    requestAnimationFrame(() => {
      if (this.overlay) {
        this.overlay.style.opacity = '1'
      }

      if (this.zoomedImg) {
        const targetTLX = targetCenterX - (rect.width * scale) / 2
        const targetTLY = targetCenterY - (rect.height * scale) / 2
        const moveX = targetTLX - rect.left
        const moveY = targetTLY - rect.top
        
        this.zoomedImg.style.transform = `translate3d(${moveX}px, ${moveY}px, 0) scale(${scale})`
      }
    })
  },

  // Close zoomed image
  close() {
    if (!this.overlay) {
      return
    }

    const isDesktop = window.innerWidth > 768

    // Reset transform and start closing animation
    if (this.zoomedImg) this.zoomedImg.style.transform = ''
    if (this.infoCard) {
      this.infoCard.style.opacity = '0'
      if (isDesktop) {
        this.infoCard.style.transform = 'translateY(-50%) translateX(20px)'
      } else {
        this.infoCard.style.transform = 'translateX(-50%) translateY(20px)'
      }
    }
    this.overlay.style.opacity = '0'
    document.body.style.overflow = ''

    // Clean up after animation completes
    setTimeout(() => {
      // Remove zoomed image
      if (this.zoomedImg && this.zoomedImg.parentNode) this.zoomedImg.parentNode.removeChild(this.zoomedImg)
      this.zoomedImg = null

      // Hide overlay
      if (this.overlay) {
        this.overlay.style.display = 'none'
      }

      // Remove floating info card
      if (this.infoCard && this.infoCard.parentNode) this.infoCard.parentNode.removeChild(this.infoCard)
      this.infoCard = null

      // Restore original image and focus
      if (this.originalImg) {
        this.originalImg.focus()
      }
      this.originalImg = null
    }, 300)
  },

  // Setup Overlay after page load
  setupOverlay() {
    this.createOverlay()
    this.zoomedImg = null
    this.originalImg = null
  },

  // Handle click events
  handleClick(event: MouseEvent) {
    if (this.zoomedImg) {
      this.close()
      return
    }

    const target = event.target
    if (!(target instanceof HTMLImageElement)) {
      return
    }

    // Check if image is larger than 100x100px
    if (!(target.complete && target.naturalWidth >= 100 && target.naturalHeight >= 100)) {
      return
    }

    // event.preventDefault()
    this.zoomImg(target)
  },

  // Handle resize events
  handleResize() {
    if (!this.zoomedImg) {
      return
    }

    this.close()
  },

  // Initialize the ImageZoom
  init() {
    this.createOverlay()

    document.addEventListener('astro:page-load', () => this.setupOverlay())
    document.addEventListener('click', event => this.handleClick(event), { passive: true })
    window.addEventListener('resize', () => this.handleResize(), { passive: true })
    document.addEventListener('keydown', (e) => {
      if (this.overlay && this.overlay.style.opacity === '1') {
        if (e.key === 'ArrowLeft') this.prev()
        if (e.key === 'ArrowRight') this.next()
        if (e.key === 'Escape') this.close()
      }
    })
  },

  // Create floating glass info card (centered lower portion)
  attachInfoCard(img: HTMLImageElement) {
    if (!this.overlay) return

    const lang = document.documentElement.lang || 'en'
    const formatDate = (iso?: string | null) => {
      if (!iso) return ''
      const d = new Date(iso)
      const m = d.getMonth() + 1
      const day = d.getDate()
      if (lang.startsWith('zh') || lang.startsWith('ja')) return `${m}月 ${day}日`
      try { return d.toLocaleDateString('en-US', { month: 'short', day: '2-digit' }) } catch { return `${m}/${day}` }
    }

    const title = img.getAttribute('data-title') || img.getAttribute('alt') || ''
    const location = img.getAttribute('data-location') || ''
    const description = img.getAttribute('data-description') || ''
    const date = formatDate(img.getAttribute('data-date'))

    this.infoCard = document.createElement('div')
    this.infoCard.setAttribute('role', 'group')
    
    const isDesktop = window.innerWidth > 768

    Object.assign(this.infoCard.style, {
      position: 'absolute',
      padding: '20px 22px 24px 22px',
      borderRadius: '16px',
      backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
      border: '1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.2)',
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
      zIndex: '2',
      display: 'flex',
      flexDirection: 'column',
      gap: '10px',
      opacity: '0',
      transition: 'opacity .35s ease, transform .45s cubic-bezier(.16,.84,.44,1)',
    })

    if (isDesktop) {
       Object.assign(this.infoCard.style, {
         right: '24px',
         top: '50%',
         transform: 'translateY(-50%) translateX(20px)',
         width: '320px',
         maxHeight: '80vh',
         overflowY: 'auto',
         backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
       })
    } else {
       Object.assign(this.infoCard.style, {
         left: '50%',
         bottom: '24px',
         transform: 'translateX(-50%) translateY(20px)',
         width: 'min(90vw, 520px)',
         maxHeight: '40vh',
         overflowY: 'auto',
         backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
       })
    }

    const closeBtn = document.createElement('button')
    closeBtn.setAttribute('aria-label', 'Close')
    Object.assign(closeBtn.style, {
      position: 'absolute',
      top: '10px',
      right: '12px',
      width: '32px', height: '32px', borderRadius: '50%',
      border: 'none',
      background: 'transparent',
      color: 'oklch(var(--un-preset-theme-colors-secondary))',
      fontSize: '20px',
      lineHeight: '32px',
      textAlign: 'center',
      cursor: 'pointer',
      transition: 'color .2s, background .2s',
    })
    closeBtn.onmouseenter = () => {
        closeBtn.style.background = 'oklch(var(--un-preset-theme-colors-secondary) / 0.1)'
        closeBtn.style.color = 'oklch(var(--un-preset-theme-colors-primary))'
    }
    closeBtn.onmouseleave = () => {
        closeBtn.style.background = 'transparent'
        closeBtn.style.color = 'oklch(var(--un-preset-theme-colors-secondary))'
    }
    closeBtn.textContent = '×'
    closeBtn.addEventListener('click', () => this.close())

    const titleEl = document.createElement('div')
    titleEl.textContent = title
    Object.assign(titleEl.style, {
      fontSize: 'clamp(1.1rem,2.2vw,1.4rem)',
      fontWeight: '700',
      letterSpacing: '.5px',
      lineHeight: '1.3',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
    })

    const metaRow = document.createElement('div')
    Object.assign(metaRow.style, {
      display: 'flex', flexWrap: 'wrap', alignItems: 'center', gap: '10px',
      fontSize: '13px',
      color: 'oklch(var(--un-preset-theme-colors-secondary))',
    })

    if (location) {
      const locEl = document.createElement('span')
      locEl.textContent = location
      Object.assign(locEl.style, { display: 'inline-flex', alignItems: 'center', gap: '4px' })
      metaRow.appendChild(locEl)
    }
    if (date) {
      const dateEl = document.createElement('span')
      dateEl.textContent = date
      Object.assign(dateEl.style, {
        padding: '4px 10px', borderRadius: '9999px',
        background: 'oklch(var(--un-preset-theme-colors-secondary) / 0.1)',
        fontSize: '12px', letterSpacing: '.5px'
      })
      metaRow.appendChild(dateEl)
    }

    if (description) {
      const descEl = document.createElement('div')
      descEl.textContent = description
      Object.assign(descEl.style, {
        fontSize: '14px', lineHeight: '1.55',
        color: 'oklch(var(--un-preset-theme-colors-secondary))',
        textOverflow: 'ellipsis'
      })
      this.infoCard.appendChild(descEl)
    }

    this.infoCard.appendChild(closeBtn)
    this.infoCard.appendChild(titleEl)
    if (location || date) this.infoCard.appendChild(metaRow)

    this.overlay.appendChild(this.infoCard)

    // Animate in
    requestAnimationFrame(() => {
      if (this.infoCard) {
        this.infoCard.style.opacity = '1'
        if (isDesktop) {
            this.infoCard.style.transform = 'translateY(-50%) translateX(0)'
        } else {
            this.infoCard.style.transform = 'translateX(-50%) translateY(0)'
        }
      }
    })
  },
}

ImageZoom.init()
</script>
