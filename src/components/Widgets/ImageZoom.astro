<script>
const ImageZoom = {
  overlay: document.querySelector('.zoom-overlay') as HTMLDivElement | null,
  zoomedImg: null as HTMLImageElement | null,
  originalImg: null as HTMLImageElement | null,
  infoCard: null as HTMLDivElement | null,
  infoBtn: null as HTMLButtonElement | null,
  currentImg: null as HTMLImageElement | null,

  showInfoButton() {
    if (!this.infoBtn)
      return
    this.infoBtn.style.display = 'flex'
  },

  hideInfoButton() {
    if (!this.infoBtn)
      return
    this.infoBtn.style.display = 'none'
  },

  // Create overlay element
  createOverlay() {
    if (this.overlay && this.overlay.isConnected) {
      return
    }

    this.overlay = document.createElement('div')
    this.overlay.classList.add('zoom-overlay')
    this.overlay.setAttribute('role', 'dialog')
    this.overlay.setAttribute('aria-modal', 'true')
    this.overlay.setAttribute('aria-label', 'Image Viewer')
    this.overlay.setAttribute('tabindex', '-1')
    Object.assign(this.overlay.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      zIndex: '9999',
      backgroundColor: 'rgba(0,0,0,0.8)',
      backdropFilter: 'blur(18px)',
      opacity: '0',
      transition: 'opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)',
      cursor: 'zoom-out',
      display: 'none',
    })

    document.body.appendChild(this.overlay)

    this.infoBtn = document.createElement('button')
    this.infoBtn.setAttribute('aria-label', 'Show info')
    this.infoBtn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><path d="M12 11v5"></path><path d="M12 8h.01"></path></svg>'
    Object.assign(this.infoBtn.style, {
      position: 'absolute',
      top: '20px',
      right: '20px',
      width: '44px',
      height: '44px',
      borderRadius: '9999px',
      border: '1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.2)',
      background: 'oklch(var(--un-preset-theme-colors-background) / 0.9)',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
      cursor: 'pointer',
      zIndex: '10000',
      display: 'none',
      alignItems: 'center',
      justifyContent: 'center',
      boxShadow: '0 2px 10px rgba(0,0,0,0.15)',
      transition: 'transform .2s ease, border-color .2s ease',
    })
    this.infoBtn.addEventListener('mouseenter', () => {
      if (!this.infoBtn)
        return
      this.infoBtn.style.transform = 'scale(1.04)'
      this.infoBtn.style.borderColor = 'oklch(var(--un-preset-theme-colors-secondary) / 0.3)'
    })
    this.infoBtn.addEventListener('mouseleave', () => {
      if (!this.infoBtn)
        return
      this.infoBtn.style.transform = 'scale(1)'
      this.infoBtn.style.borderColor = 'oklch(var(--un-preset-theme-colors-secondary) / 0.2)'
    })
    this.infoBtn.addEventListener('click', (e) => {
      e.stopPropagation()
      if (this.infoCard)
        return
      if (!this.currentImg)
        return
      this.attachInfoCard(this.currentImg)
    })
    this.overlay.appendChild(this.infoBtn)

    // Close when clicking background (but ignore clicks on floating info card)
    const overlayEl = this.overlay
    overlayEl.addEventListener('click', (e: MouseEvent) => {
      if (e.target === overlayEl)
        this.close()
    })
  },

  // Zoom in the image
  async zoomImg(img: HTMLImageElement) {
    if (!this.overlay) {
      return
    }

    // Disable scrolling and get position
    document.body.style.overflow = 'hidden'

    this.currentImg = img
    this.showInfoButton()

    const rect = img.getBoundingClientRect()
    this.originalImg = img

    // Create and style cloned image
    this.zoomedImg = img.cloneNode() as HTMLImageElement

    // Prefer full-res image for zoomed view (avoid blurry upscales)
    const fullSrc = img.getAttribute('data-full-image')
    if (fullSrc) {
      this.zoomedImg.src = fullSrc
    }
    this.zoomedImg.decoding = 'async'
    Object.assign(this.zoomedImg.style, {
      position: 'absolute',
      top: `${rect.top}px`,
      left: `${rect.left}px`,
      width: `${rect.width}px`,
      height: `${rect.height}px`,
      transition: 'transform 400ms cubic-bezier(0.2, 0, 0.2, 1)',
      zIndex: '1',
      cursor: 'zoom-out',
      transformOrigin: 'top left',
      willChange: 'transform',
      maxWidth: 'none',
      maxHeight: 'none',
      objectFit: 'contain',
    })

    // Add to overlay and show
    this.overlay.appendChild(this.zoomedImg)
    this.overlay.style.display = 'block'
    this.overlay.focus()

    // Calculate target layout
    const viewportWidth = window.innerWidth
    const viewportHeight = window.innerHeight
    const isDesktop = viewportWidth > 768

    let targetCenterX, targetCenterY, maxW, maxH

    if (isDesktop) {
      const infoWidth = 348 // Card width + smaller margin (closer to photo)
      const availW = viewportWidth - infoWidth
      targetCenterX = availW / 2
      targetCenterY = viewportHeight / 2
      maxW = availW - 40
      maxH = viewportHeight - 60
    }
    else {
      const infoHeight = 260 // Card height + smaller margin
      const availH = viewportHeight - infoHeight
      targetCenterX = viewportWidth / 2
      targetCenterY = (availH / 2) + 20 // Add some top padding
      maxW = viewportWidth - 30
      maxH = availH - 60 // More vertical padding
    }

    const scale = Math.min(maxW / rect.width, maxH / rect.height)

    // Build and attach floating info UI
    this.attachInfoCard(img)

    // Try to decode the full-res image before animating to reduce flicker/jank.
    try {
      await this.zoomedImg.decode()
    }
    catch {
      // ignore decode errors; still animate
    }

    // Start animation
    requestAnimationFrame(() => {
      if (this.overlay) {
        this.overlay.style.opacity = '1'
      }

      if (this.zoomedImg) {
        const targetTLX = targetCenterX - (rect.width * scale) / 2
        const targetTLY = targetCenterY - (rect.height * scale) / 2
        const moveX = targetTLX - rect.left
        const moveY = targetTLY - rect.top

        this.zoomedImg.style.transform = `translate3d(${moveX}px, ${moveY}px, 0) scale(${scale})`
      }
    })
  },

  // Close zoomed image
  close() {
    if (!this.overlay) {
      return
    }

    const isDesktop = window.innerWidth > 768

    // Reset transform and start closing animation
    if (this.zoomedImg)
      this.zoomedImg.style.transform = ''
    if (this.infoCard) {
      this.infoCard.style.opacity = '0'
      if (isDesktop) {
        this.infoCard.style.transform = 'translateY(-50%) translateX(20px)'
      }
      else {
        this.infoCard.style.transform = 'translateX(-50%) translateY(20px)'
      }
    }
    this.overlay.style.opacity = '0'
    document.body.style.overflow = ''

    // Clean up after animation completes
    setTimeout(() => {
      // Remove zoomed image
      if (this.zoomedImg && this.zoomedImg.parentNode)
        this.zoomedImg.parentNode.removeChild(this.zoomedImg)
      this.zoomedImg = null

      // Hide overlay
      if (this.overlay) {
        this.overlay.style.display = 'none'
      }

      // Remove info card
      if (this.infoCard && this.infoCard.parentNode)
        this.infoCard.parentNode.removeChild(this.infoCard)
      this.infoCard = null

      this.hideInfoButton()
      this.currentImg = null

      // Restore original image and focus
      if (this.originalImg) {
        this.originalImg.focus()
      }
      this.originalImg = null
    }, 300)
  },

  // Setup Overlay after page load
  setupOverlay() {
    this.createOverlay()
    this.zoomedImg = null
    this.originalImg = null
  },

  // Handle click events
  handleClick(event: MouseEvent) {
    if (this.zoomedImg) {
      this.close()
      return
    }

    const target = event.target
    if (!(target instanceof HTMLImageElement)) {
      return
    }

    // Check if image is larger than 100x100px
    if (!(target.complete && target.naturalWidth >= 100 && target.naturalHeight >= 100)) {
      return
    }

    // event.preventDefault()
    void this.zoomImg(target)
  },

  // Handle resize events
  handleResize() {
    if (!this.zoomedImg) {
      return
    }

    this.close()
  },

  // Initialize the ImageZoom
  init() {
    this.createOverlay()

    document.addEventListener('astro:page-load', () => this.setupOverlay())
    document.addEventListener('click', event => this.handleClick(event), { passive: true })
    window.addEventListener('resize', () => this.handleResize(), { passive: true })
    document.addEventListener('keydown', (e) => {
      if (this.overlay && this.overlay.style.opacity === '1') {
        if (e.key === 'Escape')
          this.close()
      }
    })
  },

  // Create floating glass info card (centered lower portion)
  attachInfoCard(img: HTMLImageElement) {
    if (!this.overlay)
      return

    const lang = document.documentElement.lang || 'en'
    const formatDate = (iso?: string | null) => {
      if (!iso)
        return ''
      const d = new Date(iso)
      const m = d.getMonth() + 1
      const day = d.getDate()
      if (lang.startsWith('zh') || lang.startsWith('ja'))
        return `${m}月 ${day}日`
      try {
        return d.toLocaleDateString('en-US', { month: 'short', day: '2-digit' })
      }
      catch {
        return `${m}/${day}`
      }
    }

    const title = img.getAttribute('data-title') || img.getAttribute('alt') || ''
    const location = img.getAttribute('data-location') || ''
    const description = img.getAttribute('data-description') || ''
    const date = formatDate(img.getAttribute('data-date'))

    const camera = img.getAttribute('data-camera') || ''
    const iso = img.getAttribute('data-iso') || ''
    const lens = img.getAttribute('data-lens') || ''
    const aperture = img.getAttribute('data-aperture') || ''
    const shutter = img.getAttribute('data-shutter') || ''
    const focalLength = img.getAttribute('data-focal-length') || ''

    const hasAnyInfo = Boolean(
      title || location || description || date || camera || iso || lens || aperture || shutter || focalLength,
    )
    if (!hasAnyInfo) {
      return
    }

    this.infoCard = document.createElement('div')
    this.infoCard.setAttribute('role', 'group')

    const isDesktop = window.innerWidth > 768

    Object.assign(this.infoCard.style, {
      position: 'absolute',
      padding: '20px 22px 24px 22px',
      borderRadius: '16px',
      backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
      border: '1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.2)',
      boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
      zIndex: '2',
      display: 'flex',
      flexDirection: 'column',
      gap: '10px',
      opacity: '0',
      transition: 'opacity .35s ease, transform .45s cubic-bezier(.16,.84,.44,1)',
    })

    if (isDesktop) {
      Object.assign(this.infoCard.style, {
        right: '16px',
        top: '50%',
        transform: 'translateY(-50%) translateX(20px)',
        width: '320px',
        maxHeight: '80vh',
        overflowY: 'auto',
        backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
      })
    }
    else {
      Object.assign(this.infoCard.style, {
        left: '50%',
        bottom: '16px',
        transform: 'translateX(-50%) translateY(20px)',
        width: 'min(90vw, 520px)',
        maxHeight: '40vh',
        overflowY: 'auto',
        backgroundColor: 'oklch(var(--un-preset-theme-colors-background) / 1)',
      })
    }

    const makeIcon = (svgPath: string) => {
      const icon = document.createElement('span')
      icon.innerHTML = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">${svgPath}</svg>`
      Object.assign(icon.style, {
        display: 'inline-flex',
        alignItems: 'center',
        justifyContent: 'center',
        width: '18px',
        height: '18px',
        flex: '0 0 18px',
        color: 'oklch(var(--un-preset-theme-colors-secondary))',
      })
      return icon
    }

    const ICONS = {
      clock: '<circle cx="12" cy="12" r="9"></circle><path d="M12 7v5l3 2"></path>',
      location: '<path d="M12 21s7-4.5 7-10a7 7 0 1 0-14 0c0 5.5 7 10 7 10z"></path><circle cx="12" cy="11" r="2"></circle>',
      camera: '<path d="M20 7h-3l-2-2H9L7 7H4v12h16V7z"></path><circle cx="12" cy="13" r="3"></circle>',
      iso: '<rect x="4" y="6" width="16" height="12" rx="2"></rect><path d="M8 10h4"></path><path d="M8 14h8"></path>',
      lens: '<circle cx="12" cy="12" r="8"></circle><circle cx="12" cy="12" r="3"></circle><path d="M12 4v4"></path><path d="M12 16v4"></path>',
      aperture: '<circle cx="12" cy="12" r="9"></circle><path d="M12 3l3 6"></path><path d="M21 12l-6 3"></path><path d="M12 21l-3-6"></path><path d="M3 12l6-3"></path><path d="M6.5 6.5l5.5 2"></path><path d="M17.5 17.5l-5.5-2"></path>',
      shutter: '<circle cx="12" cy="12" r="9"></circle><path d="M7 12h10"></path><path d="M12 7v10"></path>',
    }

    const closeBtn = document.createElement('button')
    closeBtn.setAttribute('aria-label', 'Close')
    Object.assign(closeBtn.style, {
      position: 'absolute',
      top: '10px',
      right: '12px',
      width: '32px',
      height: '32px',
      borderRadius: '50%',
      border: 'none',
      background: 'transparent',
      color: 'oklch(var(--un-preset-theme-colors-secondary))',
      fontSize: '20px',
      lineHeight: '32px',
      textAlign: 'center',
      cursor: 'pointer',
      transition: 'color .2s, background .2s',
    })
    closeBtn.onmouseenter = () => {
      closeBtn.style.background = 'oklch(var(--un-preset-theme-colors-secondary) / 0.1)'
      closeBtn.style.color = 'oklch(var(--un-preset-theme-colors-primary))'
    }
    closeBtn.onmouseleave = () => {
      closeBtn.style.background = 'transparent'
      closeBtn.style.color = 'oklch(var(--un-preset-theme-colors-secondary))'
    }
    closeBtn.textContent = '×'
    closeBtn.addEventListener('click', (e) => {
      e.stopPropagation()
      if (!this.infoCard)
        return
      this.showInfoButton()
      this.infoCard.style.opacity = '0'
      if (isDesktop) {
        this.infoCard.style.transform = 'translateY(-50%) translateX(20px)'
      }
      else {
        this.infoCard.style.transform = 'translateX(-50%) translateY(20px)'
      }
      setTimeout(() => {
        if (this.infoCard && this.infoCard.parentNode)
          this.infoCard.parentNode.removeChild(this.infoCard)
        this.infoCard = null
      }, 250)
    })

    const titleEl = document.createElement('div')
    titleEl.textContent = title
    Object.assign(titleEl.style, {
      fontSize: 'clamp(1.1rem,2.2vw,1.4rem)',
      fontWeight: '700',
      letterSpacing: '.5px',
      lineHeight: '1.3',
      color: 'oklch(var(--un-preset-theme-colors-primary))',
    })

    const metaList = document.createElement('div')
    Object.assign(metaList.style, {
      display: 'flex',
      flexDirection: 'column',
      gap: '8px',
      marginTop: '2px',
      color: 'oklch(var(--un-preset-theme-colors-secondary))',
      fontSize: '13px',
    })

    const addMetaItem = (iconKey: keyof typeof ICONS, label: string, value: string) => {
      if (!value)
        return
      const row = document.createElement('div')
      Object.assign(row.style, {
        display: 'grid',
        gridTemplateColumns: '18px 1fr',
        alignItems: 'center',
        gap: '10px',
        padding: '8px 10px',
        borderRadius: '12px',
        background: 'oklch(var(--un-preset-theme-colors-secondary) / 0.06)',
        border: '1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.12)',
      })

      const icon = makeIcon(ICONS[iconKey])
      const textWrap = document.createElement('div')
      Object.assign(textWrap.style, { display: 'flex', flexWrap: 'wrap', gap: '6px', alignItems: 'baseline' })

      const labelEl = document.createElement('span')
      labelEl.textContent = label
      Object.assign(labelEl.style, {
        fontSize: '12px',
        letterSpacing: '.3px',
        opacity: '0.85',
      })

      const valueEl = document.createElement('span')
      valueEl.textContent = value
      Object.assign(valueEl.style, {
        color: 'oklch(var(--un-preset-theme-colors-primary))',
        fontWeight: '600',
        fontSize: '13px',
        wordBreak: 'break-word',
      })

      textWrap.appendChild(labelEl)
      textWrap.appendChild(valueEl)
      row.appendChild(icon)
      row.appendChild(textWrap)
      metaList.appendChild(row)
    }

    addMetaItem('clock', lang.startsWith('zh') ? '时间' : lang.startsWith('ja') ? '日時' : 'Date', date)
    addMetaItem('location', lang.startsWith('zh') ? '地点' : lang.startsWith('ja') ? '場所' : 'Location', location)
    addMetaItem('camera', lang.startsWith('zh') ? '设备' : lang.startsWith('ja') ? 'カメラ' : 'Camera', camera)
    addMetaItem('lens', lang.startsWith('zh') ? '镜头' : lang.startsWith('ja') ? 'レンズ' : 'Lens', lens)
    addMetaItem('iso', 'ISO', iso)
    addMetaItem('aperture', lang.startsWith('zh') ? '光圈' : lang.startsWith('ja') ? '絞り' : 'Aperture', aperture)
    addMetaItem('shutter', lang.startsWith('zh') ? '快门' : lang.startsWith('ja') ? 'シャッター' : 'Shutter', shutter)
    addMetaItem('lens', lang.startsWith('zh') ? '焦距' : lang.startsWith('ja') ? '焦点距離' : 'Focal', focalLength)

    if (description) {
      const descEl = document.createElement('div')
      descEl.textContent = description
      Object.assign(descEl.style, {
        fontSize: '14px',
        lineHeight: '1.55',
        color: 'oklch(var(--un-preset-theme-colors-secondary))',
        textOverflow: 'ellipsis',
      })
      this.infoCard.appendChild(descEl)
    }

    this.infoCard.appendChild(closeBtn)
    this.infoCard.appendChild(titleEl)
    this.infoCard.appendChild(metaList)

    this.overlay.appendChild(this.infoCard)

    // Animate in
    requestAnimationFrame(() => {
      if (this.infoCard) {
        this.infoCard.style.opacity = '1'
        if (isDesktop) {
          this.infoCard.style.transform = 'translateY(-50%) translateX(0)'
        }
        else {
          this.infoCard.style.transform = 'translateX(-50%) translateY(0)'
        }
      }
    })
  },
}

ImageZoom.init()
</script>
