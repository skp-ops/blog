<script>
const ImageZoom = {
  overlay: document.querySelector('.zoom-overlay') as HTMLDivElement | null,
  zoomedImg: null as HTMLImageElement | null,
  originalImg: null as HTMLImageElement | null,
  detailWrap: null as HTMLDivElement | null,
  topBar: null as HTMLDivElement | null,

  // Create overlay element
  createOverlay() {
    if (this.overlay && this.overlay.isConnected) {
      return
    }

    this.overlay = document.createElement('div')
    this.overlay.classList.add('zoom-overlay')
    this.overlay.setAttribute('role', 'dialog')
    this.overlay.setAttribute('aria-modal', 'true')
    this.overlay.setAttribute('aria-label', 'Image Viewer')
    this.overlay.setAttribute('tabindex', '-1')
    Object.assign(this.overlay.style, {
      position: 'fixed',
      top: '0',
      left: '0',
      width: '100%',
      height: '100%',
      zIndex: '9999',
      backgroundColor: 'rgba(0,0,0,0.8)',
      backdropFilter: 'blur(18px)',
      opacity: '0',
      transition: 'opacity 300ms cubic-bezier(0.4, 0, 0.2, 1)',
      cursor: 'zoom-out',
      display: 'none',
    })

    document.body.appendChild(this.overlay)

    // Close when clicking background (but ignore clicks on detail sheet or top bar)
    const overlayEl = this.overlay
    overlayEl.addEventListener('click', (e: MouseEvent) => {
      if (e.target === overlayEl) this.close()
    })
  },

  // Zoom in the image
  zoomImg(img: HTMLImageElement) {
    if (!this.overlay) {
      return
    }

    // Disable scrolling and get position
    document.body.style.overflow = 'hidden'
    const rect = img.getBoundingClientRect()
    this.originalImg = img

    // Create and style cloned image
    this.zoomedImg = img.cloneNode() as HTMLImageElement
    Object.assign(this.zoomedImg.style, {
      position: 'fixed',
      top: `${rect.top}px`,
      left: `${rect.left}px`,
      width: `${rect.width}px`,
      height: `${rect.height}px`,
      transition: 'transform 300ms cubic-bezier(0.4, 0, 0.2, 1)',
      zIndex: '1',
      cursor: 'zoom-out',
    })

    // Add to overlay and show
    this.overlay.appendChild(this.zoomedImg)
    this.overlay.style.display = 'block'
    this.overlay.focus()

    // Calculate scale and position
    const viewportWidth = window.innerWidth
    const viewportHeight = window.innerHeight
    const scaleFactor = window.innerWidth < 768 ? 1 : 0.8
    const scale = Math.min(
      (viewportWidth * scaleFactor) / rect.width,
      (viewportHeight * scaleFactor) / rect.height,
    )
    const translateX = (-rect.left + (viewportWidth - rect.width) / 2) / scale
    const translateY = (-rect.top + (viewportHeight - rect.height) / 2) / scale

    // Build and attach details UI
    this.attachDetailsFrom(img)

    // Start animation
    requestAnimationFrame(() => {
      if (this.overlay) {
        this.overlay.style.opacity = '1'
      }

      if (this.zoomedImg) {
        this.zoomedImg.style.transform = `scale(${scale}) translate3d(${translateX}px, ${translateY}px, 0)`
      }
    })
  },

  // Close zoomed image
  close() {
    if (!this.overlay) {
      return
    }

    // Reset transform and start closing animation
    if (this.zoomedImg) this.zoomedImg.style.transform = ''
    this.overlay.style.opacity = '0'
    document.body.style.overflow = ''

    // Clean up after animation completes
    setTimeout(() => {
      // Remove zoomed image
      if (this.zoomedImg && this.zoomedImg.parentNode) this.zoomedImg.parentNode.removeChild(this.zoomedImg)
      this.zoomedImg = null

      // Hide overlay
      if (this.overlay) {
        this.overlay.style.display = 'none'
      }

      // Remove detail sheet and top bar
      if (this.detailWrap && this.detailWrap.parentNode) this.detailWrap.parentNode.removeChild(this.detailWrap)
      if (this.topBar && this.topBar.parentNode) this.topBar.parentNode.removeChild(this.topBar)
      this.detailWrap = null
      this.topBar = null

      // Restore original image and focus
      if (this.originalImg) {
        this.originalImg.focus()
      }
      this.originalImg = null
    }, 300)
  },

  // Setup Overlay after page load
  setupOverlay() {
    this.createOverlay()
    this.zoomedImg = null
    this.originalImg = null
  },

  // Handle click events
  handleClick(event: MouseEvent) {
    if (this.zoomedImg) {
      this.close()
      return
    }

    const target = event.target
    if (!(target instanceof HTMLImageElement)) {
      return
    }

    // Check if image is larger than 100x100px
    if (!(target.complete && target.naturalWidth >= 100 && target.naturalHeight >= 100)) {
      return
    }

    // event.preventDefault()
    this.zoomImg(target)
  },

  // Handle resize events
  handleResize() {
    if (!this.zoomedImg) {
      return
    }

    this.close()
  },

  // Initialize the ImageZoom
  init() {
    this.createOverlay()

    document.addEventListener('astro:page-load', () => this.setupOverlay())
    document.addEventListener('click', event => this.handleClick(event), { passive: true })
    window.addEventListener('resize', () => this.handleResize(), { passive: true })
  },

  // Build iOS-style glass details from image dataset
  attachDetailsFrom(img: HTMLImageElement) {
    if (!this.overlay) return

    const lang = document.documentElement.lang || 'en'
    const formatDate = (iso?: string | null) => {
      if (!iso) return ''
      const d = new Date(iso)
      const m = d.getMonth() + 1
      const day = d.getDate()
      if (lang.startsWith('zh') || lang.startsWith('ja')) return `${m}月 ${day}日`
      try { return d.toLocaleDateString('en-US', { month: 'short', day: '2-digit' }) } catch { return `${m}/${day}` }
    }

    const title = img.getAttribute('data-title') || img.getAttribute('alt') || ''
    const location = img.getAttribute('data-location') || ''
    const description = img.getAttribute('data-description') || ''
    const date = formatDate(img.getAttribute('data-date'))

    // Top bar (close / more)
    this.topBar = document.createElement('div')
    Object.assign(this.topBar.style, {
      position: 'absolute',
      top: '0',
      left: '0',
      right: '0',
      padding: '16px',
      display: 'flex',
      justifyContent: 'space-between',
      alignItems: 'center',
      zIndex: '3',
      background: 'linear-gradient(to bottom, rgba(0,0,0,0.55), rgba(0,0,0,0))',
      pointerEvents: 'none',
    })

    const makeIconBtn = (label: string) => {
      const btn = document.createElement('button')
      btn.setAttribute('aria-label', label)
      Object.assign(btn.style, {
        width: '40px', height: '40px', borderRadius: '9999px',
        background: 'rgba(255,255,255,0.12)', color: 'white', border: '1px solid rgba(255,255,255,0.2)',
        backdropFilter: 'blur(10px)', display: 'flex', alignItems: 'center', justifyContent: 'center',
        pointerEvents: 'auto'
      })
      return btn
    }

    const closeBtn = makeIconBtn('Close')
    closeBtn.innerHTML = '&#10005;'
    closeBtn.addEventListener('click', () => this.close())

    const moreBtn = makeIconBtn('More')
    moreBtn.innerHTML = '&#8942;'

    this.topBar.appendChild(closeBtn)
    this.topBar.appendChild(moreBtn)

    // Detail glass sheet
    this.detailWrap = document.createElement('div')
    Object.assign(this.detailWrap.style, {
      position: 'absolute',
      left: '0', right: '0', bottom: '0',
      zIndex: '2',
      padding: '16px 16px 24px 16px',
      background: 'rgba(24,24,24,0.55)',
      backdropFilter: 'blur(16px)',
      borderTop: '1px solid rgba(255,255,255,0.1)',
      color: 'white',
    })

    const titleEl = document.createElement('div')
    titleEl.textContent = title
    Object.assign(titleEl.style, { fontWeight: '800', fontSize: '20px', marginBottom: '4px' })

    const metaRow = document.createElement('div')
    Object.assign(metaRow.style, { display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: '12px', marginBottom: '8px' })

    const locationEl = document.createElement('div')
    locationEl.textContent = location
    Object.assign(locationEl.style, { opacity: '0.85', fontSize: '13px' })

    const datePill = document.createElement('span')
    datePill.textContent = date
    Object.assign(datePill.style, {
      fontSize: '12px', padding: '4px 8px', borderRadius: '9999px', whiteSpace: 'nowrap',
      background: 'rgba(255,255,255,0.16)', border: '1px solid rgba(255,255,255,0.28)'
    })

    metaRow.appendChild(locationEl)
    metaRow.appendChild(datePill)

    const descEl = document.createElement('div')
    descEl.textContent = description
    Object.assign(descEl.style, { opacity: '0.9', fontSize: '14px', lineHeight: '1.5', marginTop: '8px' })

    this.detailWrap.appendChild(titleEl)
    if (location) this.detailWrap.appendChild(metaRow)
    if (description) this.detailWrap.appendChild(descEl)

    // Attach to overlay
    this.overlay.appendChild(this.topBar)
    this.overlay.appendChild(this.detailWrap)
  },
}

ImageZoom.init()
</script>
