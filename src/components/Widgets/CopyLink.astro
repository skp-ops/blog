---
interface Props {
  url?: string
}

const { url } = Astro.props
---

<button
  class="copy-link-button"
  data-url={url}
  aria-label="Copy link"
  title="Copy link to clipboard"
>
  <svg class="copy-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
  </svg>
  <svg class="check-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
    <polyline points="20 6 9 17 4 12"></polyline>
  </svg>
  <span class="copy-text">Copy Link</span>
</button>

<style>
  .copy-link-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.2);
    border-radius: 0.375rem;
    background: oklch(var(--un-preset-theme-colors-background));
    color: oklch(var(--un-preset-theme-colors-secondary));
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .copy-link-button:hover {
    border-color: oklch(var(--un-preset-theme-colors-primary) / 0.4);
    color: oklch(var(--un-preset-theme-colors-primary));
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.05);
  }

  .copy-link-button:active {
    transform: scale(0.95);
  }

  .copy-link-button.copy-success {
    border-color: #10b981;
    color: #059669;
    background: #d1fae5;
  }

  html.dark .copy-link-button.copy-success {
    border-color: rgba(16, 185, 129, 0.6);
    color: #34d399;
    background: rgba(6, 78, 59, 0.3);
  }

  .copy-link-button svg {
    flex-shrink: 0;
  }

  @media (max-width: 640px) {
    .copy-text {
      display: none;
    }
  }
</style>

<script>
function initCopyLink() {
  const copyButton = document.querySelector('.copy-link-button') as HTMLButtonElement

  if (!copyButton)
    return

  const copyIcon = copyButton.querySelector('.copy-icon') as SVGElement
  const checkIcon = copyButton.querySelector('.check-icon') as SVGElement
  const copyText = copyButton.querySelector('.copy-text') as HTMLSpanElement

  copyButton.addEventListener('click', async () => {
    const url = copyButton.dataset.url || window.location.href

    try {
      await navigator.clipboard.writeText(url)

      // Show success state
      copyIcon.style.display = 'none'
      checkIcon.style.display = 'block'
      copyText.textContent = 'Copied!'
      copyButton.classList.add('copy-success')

      // Reset after 2 seconds
      setTimeout(() => {
        copyIcon.style.display = 'block'
        checkIcon.style.display = 'none'
        copyText.textContent = 'Copy Link'
        copyButton.classList.remove('copy-success')
      }, 2000)
    }
    catch (err) {
      console.error('Failed to copy:', err)
      copyText.textContent = 'Failed'

      setTimeout(() => {
        copyText.textContent = 'Copy Link'
      }, 2000)
    }
  })
}

// Initialize on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initCopyLink)
}
else {
  initCopyLink()
}

// Re-initialize after view transitions
document.addEventListener('astro:after-swap', initCopyLink)
</script>
