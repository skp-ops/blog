---
/**
 * Theme Switcher Component
 * Allows users to switch between preset themes or input custom OKLCH colors
 */
---

<div id="theme-switcher-modal" class="theme-switcher-modal hidden">
  <div class="theme-switcher-backdrop"></div>
  <div class="theme-switcher-panel">
    <div class="theme-switcher-header">
      <h3 class="theme-switcher-title">Choose Theme</h3>
      <button
        id="theme-switcher-close"
        class="theme-switcher-close"
        aria-label="Close theme switcher"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>

    <div class="theme-switcher-content">
      <!-- Preset Themes -->
      <section class="theme-section">
        <h4 class="theme-section-title">Preset Themes</h4>
        <div id="theme-presets" class="theme-presets-grid"></div>
      </section>
    </div>
  </div>
</div>

<!-- Theme Switcher Button (shown in navbar area) -->
<button
  id="theme-switcher-button"
  class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
  aria-label="Change theme colors"
>
  <svg
    width="16"
    height="16"
    viewBox="0 0 16 16"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    aria-hidden="true"
  >
    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none" />
    <circle cx="8" cy="8" r="3" fill="currentColor" />
  </svg>
</button>

<style>
  .theme-switcher-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .theme-switcher-modal.hidden {
    display: none;
  }

  .theme-switcher-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .theme-switcher-panel {
    position: relative;
    background: var(--un-preset-theme-colors-background, oklch(0.975 0.003 45));
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    z-index: 1;
  }

  html.dark .theme-switcher-panel {
    background: var(--un-preset-theme-colors-background, oklch(0.18 0.015 45));
  }

  .theme-switcher-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid oklch(var(--un-preset-theme-colors-secondary) / 0.15);
  }

  .theme-switcher-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--un-preset-theme-colors-primary, oklch(0.20 0.01 45));
  }

  html.dark .theme-switcher-title {
    color: var(--un-preset-theme-colors-primary, oklch(0.92 0.015 45));
  }

  .theme-switcher-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--un-preset-theme-colors-secondary, oklch(0.55 0.015 45));
    transition: color 0.2s;
  }

  .theme-switcher-close:hover {
    color: var(--un-preset-theme-colors-primary, oklch(0.20 0.01 45));
  }

  html.dark .theme-switcher-close:hover {
    color: var(--un-preset-theme-colors-primary, oklch(0.92 0.015 45));
  }

  .theme-switcher-content {
    padding: 1.5rem;
  }

  .theme-section {
    margin-bottom: 2rem;
  }

  .theme-section:last-child {
    margin-bottom: 0;
  }

  .theme-section-title {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--un-preset-theme-colors-primary, oklch(0.20 0.01 45));
  }

  html.dark .theme-section-title {
    color: var(--un-preset-theme-colors-primary, oklch(0.92 0.015 45));
  }

  .theme-presets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.75rem;
  }

  .theme-preset-card {
    cursor: pointer;
    border: 2px solid oklch(var(--un-preset-theme-colors-secondary) / 0.15);
    border-radius: 8px;
    padding: 0.875rem;
    text-align: center;
    transition: all 0.2s;
    background: oklch(var(--un-preset-theme-colors-secondary) / 0.05);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .theme-preset-card:hover {
    border-color: oklch(var(--un-preset-theme-colors-secondary) / 0.4);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  .theme-preset-card:active {
    transform: translateY(0);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .theme-preset-card.active {
    border-color: var(--un-preset-theme-colors-primary, oklch(0.20 0.01 45));
    background: oklch(var(--un-preset-theme-colors-primary) / 0.08);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  }

  html.dark .theme-preset-card.active {
    border-color: var(--un-preset-theme-colors-primary, oklch(0.92 0.015 45));
  }

  .theme-preset-preview {
    display: flex;
    gap: 4px;
    justify-content: center;
    margin-bottom: 0.5rem;
  }

  .theme-preset-color {
    width: 24px;
    height: 24px;
    border-radius: 4px;
  }

  .theme-preset-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--un-preset-theme-colors-primary, oklch(0.20 0.01 45));
    text-transform: capitalize;
  }

  html.dark .theme-preset-name {
    color: var(--un-preset-theme-colors-primary, oklch(0.92 0.015 45));
  }


</style>

<script>
import {
  applyThemePreset,
  getSavedThemePreset,
  getThemePresets,
} from '@/utils/theme-manager'

// Open/Close modal - need to rebind after page navigation
function initThemeSwitcher() {
  const modal = document.getElementById('theme-switcher-modal')
  const openButton = document.getElementById('theme-switcher-button')
  const closeButton = document.getElementById('theme-switcher-close')
  const backdrop = modal?.querySelector('.theme-switcher-backdrop')

  if (!modal || !openButton)
    return

  function openModal() {
    modal?.classList.remove('hidden')
    document.body.style.overflow = 'hidden'
  }

  function closeModal() {
    modal?.classList.add('hidden')
    document.body.style.overflow = ''
  }

  // Remove old listeners and add new ones
  openButton.removeEventListener('click', openModal)
  openButton.addEventListener('click', openModal)

  closeButton?.removeEventListener('click', closeModal)
  closeButton?.addEventListener('click', closeModal)

  backdrop?.removeEventListener('click', closeModal)
  backdrop?.addEventListener('click', closeModal)

  // Render preset themes
  renderPresets()
}

function renderPresets() {
  const container = document.getElementById('theme-presets')
  if (!container)
    return

  const presets = getThemePresets()
  const savedPreset = getSavedThemePreset()
  const isDark = document.documentElement.classList.contains('dark')

  container.innerHTML = presets.map((preset) => {
    const colors = isDark ? preset.dark : preset.light
    const isActive = savedPreset === preset.name

    return `
      <div class="theme-preset-card ${isActive ? 'active' : ''}" data-preset="${preset.name}">
        <div class="theme-preset-preview">
          <div class="theme-preset-color" style="background: ${colors.primary}"></div>
          <div class="theme-preset-color" style="background: ${colors.secondary}"></div>
          <div class="theme-preset-color" style="background: ${colors.highlight}"></div>
        </div>
        <div class="theme-preset-name">${preset.name}</div>
      </div>
    `
  }).join('')

  // Add click handlers
  container.querySelectorAll('.theme-preset-card').forEach((card) => {
    card.addEventListener('click', () => {
      const presetName = card.getAttribute('data-preset')
      if (presetName && applyThemePreset(presetName)) {
        renderPresets() // Re-render to update active state
      }
    })
  })
}

// Initialize on load
initThemeSwitcher()

// Re-initialize after page navigation (Astro view transitions)
document.addEventListener('astro:page-load', () => {
  initThemeSwitcher()
})

// Re-render when theme mode changes
document.addEventListener('theme-changed', () => {
  renderPresets()
})
</script>
